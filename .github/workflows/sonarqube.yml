name: SonarQube Analysis

permissions:
  contents: read

on:
  workflow_call:
  schedule:
    - cron: '0 3 * * 1'  # Weekly on Monday at 3 AM UTC

jobs:
  sonarqube:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    services:
      sonarqube:
        image: sonarqube:community
        ports:
          - 9000:9000
        env:
          SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Wait for SonarQube
        run: |
          timeout 300 bash -c 'until curl -s http://localhost:9000/api/system/status | grep -q "UP"; do sleep 5; done'
      
      - name: Generate SonarQube token
        run: |
          # Wait a bit more for SonarQube to be fully ready
          sleep 10
          # Generate a token using the default admin:admin credentials
          TOKEN=$(curl -s -u admin:admin -X POST "http://localhost:9000/api/user_tokens/generate?name=github-actions" | jq -r '.token')
          echo "SONAR_TOKEN=$TOKEN" >> $GITHUB_ENV
      
      - name: Setup SonarQube Scanner
        uses: warchant/setup-sonar-scanner@v8
      
      - name: Run SonarQube Analysis
        run: |
          sonar-scanner \
            -Dsonar.projectKey=stormlit \
            -Dsonar.sources=. \
            -Dsonar.host.url=http://localhost:9000 \
            -Dsonar.token=$SONAR_TOKEN \
            -Dsonar.exclusions="**/*.yml,**/*.yaml,**/*.json,**/node_modules/**,**/cdktf.out/**"
      
      - name: Get SonarQube Results
        run: |
          # Wait for analysis to be processed
          sleep 10
          
          echo "## SonarQube Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get project measures
          MEASURES=$(curl -s -u admin:admin "http://localhost:9000/api/measures/component?component=stormlit&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density,ncloc,sqale_rating,reliability_rating,security_rating")
          
          echo "### Key Metrics:" >> $GITHUB_STEP_SUMMARY
          echo "$MEASURES" | jq -r '.component.measures[] | "- **\(.metric)**: \(.value // "N/A")"' >> $GITHUB_STEP_SUMMARY
          
          # Get issues summary
          ISSUES=$(curl -s -u admin:admin "http://localhost:9000/api/issues/search?componentKeys=stormlit&facets=severities,types")
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Issues by Severity:" >> $GITHUB_STEP_SUMMARY
          echo "$ISSUES" | jq -r '.facets[] | select(.property == "severities") | .values[] | "- **\(.val)**: \(.count)"' >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Issues by Type:" >> $GITHUB_STEP_SUMMARY
          echo "$ISSUES" | jq -r '.facets[] | select(.property == "types") | .values[] | "- **\(.val)**: \(.count)"' >> $GITHUB_STEP_SUMMARY